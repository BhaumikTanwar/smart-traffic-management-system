<!DOCTYPE html>
<html>
<head>
    <title>Smart Traffic Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial; background:#f4f6f8; padding:20px; }
        h1 { margin-bottom:20px; }

        .section {
            margin-top:30px;
            background:white;
            padding:25px;
            border-radius:12px;
            box-shadow:0 4px 20px rgba(0,0,0,0.08);
        }

        button {
            padding:10px 18px;
            border-radius:6px;
            border:none;
            background:#667eea;
            color:white;
            cursor:pointer;
            margin-right:10px;
        }

        .badge {
            background:#38a169;
            padding:6px 12px;
            border-radius:20px;
            color:white;
            font-weight:bold;
        }

        .cards {
            display:flex;
            gap:20px;
        }

        .card {
            background:#fafafa;
            padding:20px;
            border-radius:10px;
            width:220px;
        }

        .value {
            font-size:24px;
            font-weight:bold;
            margin-top:10px;
        }

        #videoSection { display:none; }
        #videoFeedContainer { display:none; margin-top:20px; }
    </style>
</head>

<body>

<h1>üö¶ Smart Traffic Admin Dashboard</h1>

<div class="section">
    <h2>‚öôÔ∏è System Controls</h2>
    <button onclick="setMode('simulation')">Simulation Mode</button>
    <button onclick="setMode('video')">Video Mode</button>
    <span class="badge" id="currentModeBadge">Mode: --</span>
</div>

<div class="section">
    <div class="cards">
        <div class="card">
            Vehicle Count
            <div class="value" id="vehicleCount">--</div>
        </div>

        <div class="card">
            Congestion Level
            <div class="value" id="congestion">--</div>
        </div>

        <div class="card">
            Adaptive Green Time
            <div class="value" id="greenTime">--</div>
        </div>
    </div>
</div>

<div class="section">
    <h2>üìä Traffic Trend</h2>
    <canvas id="trafficChart" height="100"></canvas>
</div>

<div class="section" id="videoSection">
    <h2>üé• Upload Video for Detection</h2>
    <input type="file" id="videoInput">
    <button onclick="uploadVideo()">Upload</button>

    <div id="videoFeedContainer">
        <img src="{{ url_for('video_feed') }}" width="100%" />
    </div>
</div>

<script>

let vehicleData = [];
let timeLabels = [];

const ctx = document.getElementById('trafficChart').getContext('2d');

const trafficChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: timeLabels,
        datasets: [{
            label: 'Vehicle Count',
            data: vehicleData,
            borderWidth:2,
            tension:0.3
        }]
    },
    options: {
        responsive:true,
        scales:{ y:{ beginAtZero:true } }
    }
});

function setMode(mode) {
    fetch(`/set-mode/${mode}`)
    .then(res => res.json())
    .then(data => {

        document.getElementById("currentModeBadge").innerText =
            "Mode: " + data.current_mode.toUpperCase();

        if(mode === "video"){
            document.getElementById("videoSection").style.display = "block";
            document.getElementById("vehicleCount").innerText = "--";
            document.getElementById("congestion").innerText = "Waiting for video...";
            document.getElementById("greenTime").innerText = "--";
        } 
        else {
            document.getElementById("videoSection").style.display = "none";
            document.getElementById("videoFeedContainer").style.display = "none";
        }
    });
}

function uploadVideo(){
    const file = document.getElementById("videoInput").files[0];

    if(!file){
        alert("Select a video first.");
        return;
    }

    const formData = new FormData();
    formData.append("video", file);

    fetch("/upload-video", {
        method:"POST",
        body:formData
    })
    .then(res=>res.json())
    .then(data=>{
        alert("Video Uploaded!");
        document.getElementById("videoFeedContainer").style.display="block";
    });
}

function loadTraffic(){
    fetch("/api/traffic-status")
    .then(res=>res.json())
    .then(data=>{

        document.getElementById("currentModeBadge").innerText =
            "Mode: " + data.current_mode.toUpperCase();

        // üö´ VIDEO MODE but no upload yet
        if(data.current_mode === "video" && data.video_ready === false){
            document.getElementById("vehicleCount").innerText = "--";
            document.getElementById("congestion").innerText = "Waiting for video...";
            document.getElementById("greenTime").innerText = "--";
            return;
        }

        const road = data.roads[0];

        document.getElementById("vehicleCount").innerText = road.vehicle_count;
        document.getElementById("greenTime").innerText =
            road.adaptive_green_time + " sec";
        document.getElementById("congestion").innerText =
            road.congestion_level;

        // Update Graph
        timeLabels.push(data.timestamp);
        vehicleData.push(road.vehicle_count);

        if(timeLabels.length > 10){
            timeLabels.shift();
            vehicleData.shift();
        }

        trafficChart.update();
    });
}

// Always run updates
setInterval(loadTraffic, 5000);
loadTraffic();

</script>

</body>
</html>